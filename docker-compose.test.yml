version: "3.8"

services:
  # SQL Server database
  sqlserver:
    container_name: sqlserver_test
    image: mcr.microsoft.com/mssql/server:2022-latest
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong@Passw0rd
      - MSSQL_PID=Developer
    volumes:
      - sqlserver_data:/var/opt/mssql
    networks:
      - test-network
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q "SELECT 1" -C || exit 1
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s

  # Bank simulator (mock bank API)
  bank_simulator:
    container_name: bank_simulator_test
    image: bbyars/mountebank:2.8.1
    ports:
      - "2525:2525"
      - "8080:8080"
    command: --configfile /imposters/bank_simulator.ejs --allowInjection
    volumes:
      - type: bind
        source: ./imposters
        target: /imposters
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:2525"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  # Payment Gateway API
  payment_gateway:
    container_name: payment_gateway_test
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - BankApiUrl=http://bank_simulator:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=PaymentGatewayDb;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;
      - Authentication__ApiKeys__0=test-api-key-1
      - Authentication__ApiKeys__1=test-api-key-2
      - Authentication__ApiKeys__2=merchant-demo-key
    depends_on:
      sqlserver:
        condition: service_healthy
      bank_simulator:
        condition: service_healthy
    networks:
      - test-network

  # E2E Test Runner
  test_runner:
    container_name: test_runner
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - PAYMENT_GATEWAY_URL=http://payment_gateway:5000
    depends_on:
      - payment_gateway
    networks:
      - test-network
    volumes:
      - type: bind
        source: ${TEST_RESULTS_DIR:-./test-results}
        target: /test-results
    command: >
      sh -c "
        echo 'Waiting for Payment Gateway to be fully ready...' &&
        sleep 30 &&
        echo 'Running E2E tests...' &&
        dotnet test --filter 'Category=E2E' --logger 'trx;LogFileName=/test-results/e2e-results.trx' --logger 'html;LogFileName=/test-results/e2e-results.html' --logger 'console;verbosity=detailed' --results-directory /test-results -- NUnit.NumberOfTestWorkers=1
      "

networks:
  test-network:
    driver: bridge

volumes:
  sqlserver_data:
    driver: local
